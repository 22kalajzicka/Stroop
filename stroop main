<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Main Stroop Task</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  #word { font-size: 48px; margin: 50px; }
  #feedback { font-size: 20px; margin-top: 30px; }
</style>
</head>
<body>
<div id="word"></div>
<div id="feedback"></div>

<script>
const colors = ["red","green","blue","yellow"];
const keys = {r:"red", g:"green", b:"blue", y:"yellow"};
const totalTrials = 40;  // main task
let i = 0;

// Arrays to store results
let words = [], inks = [], pressedKeys = [], correctness = [], rts = [];

function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function makeTrial(){
  let word = randomChoice(colors);
  let ink = randomChoice(colors.filter(c => c !== word)); // always incongruent
  return {word, ink};
}

function nextTrial(){
  if(i >= totalTrials){
    document.getElementById("word").innerHTML = "Task complete!";
    document.getElementById("feedback").innerHTML = "<br>Sending results to Qualtrics...";

    const data = {
      stroop_words: words.join("|"),
      stroop_inks: inks.join("|"),
      stroop_pressed: pressedKeys.join("|"),
      stroop_correct: correctness.join("|"),
      stroop_rt: rts.join("|"),
      stroop_accuracy: (correctness.filter(c=>c===1).length / correctness.length*100).toFixed(1),
      stroop_avgRT: Math.round(rts.reduce((a,b)=>a+b,0)/rts.length)
    };

    window.parent.postMessage(data, "*");
    return;
  }

  let trial = makeTrial();
  document.getElementById("word").innerHTML = `<span style="color:${trial.ink}">${trial.word.toUpperCase()}</span>`;
  document.getElementById("feedback").innerHTML = "";

  let start = performance.now();

  function keyHandler(e){
    let pressed = e.key ? e.key.toLowerCase() : '';
    if(keys[pressed]){
      let rt = Math.round(performance.now() - start);
      let pressedColor = keys[pressed];
      let correct = (pressedColor === trial.ink) ? 1 : 0;

      // Save trial results
      words.push(trial.word);
      inks.push(trial.ink);
      pressedKeys.push(pressedColor);
      correctness.push(correct);
      rts.push(rt);

      // Word disappears immediately
      document.getElementById("word").innerHTML = "";

      window.removeEventListener("keydown", keyHandler);
      i++;

      // 1-second interval before next trial
      setTimeout(nextTrial, 1000);
    }
  }

  window.addEventListener("keydown", keyHandler);
}

nextTrial();
</script>
</body>
</html>
